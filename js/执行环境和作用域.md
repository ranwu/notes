在JavaScript中搞清楚程序的执行环境和作用域非常重要，比如，`this`的区分，这个时候你必须具备区别不同作用域下`this`代表哪个作用域的能力。

### 先说说执行环境

执行环境（excution context）定义了 `变量`或`函数`有权访问的其他数据，以及决定了它们的各自的行为。每个执行环境都有一个与执行环境相关联的 *变量对象（variable object）*，函数中所有的 *变量和函数* 都保存在这个变量对象中。

在`Web`浏览器中，全局执行执行环境被认为是 `window` 对象。因此所有全局变量和函数都是作为`window`对象的属性和方法创建的。

每个函数有自己的执行环境。当执行流进入一个函数时，函数的环境就会被推入一个环境栈中。而在函数执行完毕后，栈将其环境弹出，把控制权返回给之前的执行环境。

当代码在一个执行环境执行时，会创建变量对象的一个 *作用域链（scope chain）*。作用域链的作用就是保证对执行环境中的变量和函数的有序访问。作用域链的前端始终都是当前代码所在环境的变量对象。

如果这个环境是函数，则将其活动对象（activation object）作为变量对象。作用域链的前端，始终都是当前执行环境的代码所在环境的变量对象。如果这个环境是函数，则将其 *活动对象（activation object）*作为变量对象。活动对象在最开始时，只包含一个变量，即`arguments`对象（这个对象在全局环境中是不存在的）。也就是这个 `arguments` 对象，在前面的章节见到过，当我们往一个函数里传入参数的时候，这些参数都保存在 `arguments` 对象当中，我们可以通过 `arguments[x]` 来访问参数，这里的 `x` 表示下标。作用域链其实就是一个嵌套的环境，最顶层也许是函数环境，紧接着的下一层也许还是函数环境，直到最后一层，浏览器窗口对象`window`。

看一个例子：

```javascript
var color = "blue";

function changeColor() {
    if (color === "blue") {
        color = "red";
    } else {
        color = "blue";
    }
}

changeColor();

alert("Color is now " + color);
```

来分析下这个程序，分清楚有它的作用域链结构。怎么来判断到底有几层执行环境呢？作用域链是从前端到后端，最后一层肯定是`window`对象。第一句是一个变量，第二句是个函数，基于这个函数有个新的执行环境。运行的时候，这个基于函数的执行环境会被加载到环境栈中，等到这个函数执行完毕，再弹出环境栈。第三句是一个调用函数，也就是执行这个函数了。第四句是打印内容，是个函数。但是第四句这个函数是属于哪个对象的呢？嗯，`window`对象。也就是说，这个程序总共两层作用域链。

记住一点，作用域链最外层为`window`，然后可以嵌套任意多的函数，每一层函数只能向上访问，而不能向下访问。

变量对象是作用域链的基本节点。

对于if 语句和 for语句里面的变量，当这两个语句执行完毕后，并不会立即销毁变量，这些变量仍然存在于语句外面的执行环境中。