获取文件系统的快照，需要用到LVM。

先澄清几核心术语。热备份、暖备份和冷备份。

例如：“热备份”不需要任何的服务停机时间。

还原和恢复。还原意味着从备份文件中获取数据，可以加载这些文件到MySQL里，也可以将这些文件放置到MySQL期望的路径中。

恢复指的是当某些异常发生后对一个系统或其部分的拯救。包括从备份中还原数据，以及使服务器完全恢复功能的所有必要步骤，例如重启MySQL，改变配置和**预热服务器**的缓存等。

在很多人的概念中，恢复仅意味着修复崩溃后损坏的表。这与恢复一个完整的服务器是不同的。存储引擎的崩溃恢复要求数据和日志文件一致。要求确保数据文件中只包含已经提交的事务所做的续改，恢复操作会将日志中还没有应用到数据文件的事务重新执行。

### 定义恢复需求

还需要一个强大的恢复系统。

让备份系统平滑工作比构造良好的恢复过程和工具更容易。原因如下：

- 备份在先。只有已经做了备份才可能恢复，因此在构建系统时，注意力自然会集中到备份上。
- 备份由脚本和任务自动完成。要经常调优备份过程。
- 备份是日常任务，但恢复常常发生在危急情形下。
- 培养多个人来备份。

`mysqldump` 加上 `-d` 选项后备份变得像闪电一样。为什么？因为使用`-d`选项将不会备份数据！既要关注备份也要关注恢复。

规划备份和恢复策略时，有两个重要的需求可以帮助思考：

1. 恢复点目标（RPO）
2. 恢复时间目标（RTO）

作用是定义了可以容忍丢失多少数据，以及需要等待多久将数据恢复。

>备份误区：“复制就是备份”。复制不是备份，使用RAID阵列也不是备份。为什么这么说呢？如果意外地在生产服务器上执行了DROP DATABASE，它们是否可以帮你恢复所有的数据？RAID和复制连这个简单的测试都没法通过。所以它们不是备份，也不是备份的替代品。只有备份才能满足备份的要求。

建议：

- 对于大数据库来说，物理备份是必须的：逻辑备份太慢并受到资源限制，从逻辑备份中恢复需要很长的时间。
- 保留多个备份集。
- 定期从逻辑备份（或者物理备份）中抽取数据进行恢复测试。
- 保存二进制日志以用于基于故障时间点的恢复。
- 完全不借助备份工具本身来监控备份和备份的过程。需要另外验证备份是否正常。
- 通过演练整个恢复过程来测试备份和恢复。目的是测算恢复所需要的资源（CPU、磁盘空间、实际时间，以及网络带宽等）。

基于故障时间点的恢复，可能要建立**日常备份**并保证所需要的**二进制日志**是有效的。这样才能从备份中还原，并通过重放二进制日志来恢复到想要的时间点。

### 在线备份还是离线备份

离线备份的风险最小。因为如果关闭了MySQL，就根本不用关心InnoDB缓冲池中的脏页或其他缓存。也不需要担心数据在尝试备份的过程被修改。

停机备份的代价更昂贵。怎么才能让这一损失降低到最低？

在众多的备份方法中，一个最大的问题就是它们会使用FLUSH TABLES WITH READ LOCK操作。这会导致MySQL关闭并锁住所有的表，将MyISAM的数据文件刷新到磁盘上（但InnoDB不是这样的！），并且刷新查询缓存。但这样做会需要非常长的时间来完成。如果全局读锁要等待一个长时间运行的语句完成，或有许多表，那么时间会更长。除非锁被释放，否则就不能在服务器上更改任何数据，一切都会被阻塞和积压。FLUSH TABLES WITH READ LOCK不像关闭服务器的代价那么高，因为大部分缓存仍然在内存中，并且服务器一直是“预热的”，也就是没有断电。

避免使用FLUSH TABLE WITH READ LOCK的最好的方法是只使用InnoDB表。

在规划备份时，有一些与性能相关的因素需要考虑。

*锁时间*
需要持有锁多长时间？我的理解就是当数据库中的这些表被锁住的时候，我们就可以使用热备份。

*备份时间*
复制备份到目的地需要多久？这个要怎么计算？

*备份负载*
在复制备份到目的地时对服务器性能的影响有多少？

*恢复时间*
把备份镜像从存储位置复制到MySQL服务器，重放二进制日志等，需要多久？

最大的权衡是备份时间与备份负载。可以牺牲其一以增强另外一个。例如提高备份的优先级，代价是降低服务器性能，服务器性能降低了就有可能导致客户访问网站变慢。

利用负载的特性来设计备份。

### 逻辑备份还是物理备份

两种主要方法来备份MySQL数据：逻辑备份（也叫“导出”）和直接复制原始文件的物理备份。逻辑备份将数据包含在一种MySQL能偶解析的格式中，比如后缀名为SQL的文件。

*逻辑备份的优点：*
- 逻辑备份是可以用编辑器或像grep和sed之类的命令查看和操作的普通文件。当需要恢复数据或只想查看数据但不恢复时，这都非常有帮助。
- 恢复非常简单。可以通过管道把她们输入到mysql，或者使用mysqlimport。
- 可以通过网络来备份和恢复。
- 可以在类似Amazon RDS这样不能访问底层文件系统的系统中使用。
- 非常灵活，用mysqldump可以用WHERE子句来限制需要备份哪些行。
- 与存储引擎无关。为什么呢？因为是从MySQL服务器中提取数据而生成，所以消除了底层数据存储和不同。因此，可以从InnoDB表中备份，然后只需极小的工作量就可以还原到MyISAM表中（WHAT‘S MyISAM？）
- 有助于避免数据损坏。如果磁盘出现故障，但是MySQL的数据还存在内存当中，且不能得到一个正常的备份时，有时可以获得一个可以信赖的逻辑备份。恩，也就是说，逻辑备份可以和磁盘无关联，即使磁盘有问题，也可以从内存中再备份。

*逻辑备份的缺点*
- 由于需要由数据库服务器来完成逻辑备份的工作，因此要使用更多的CPU周期。也就是耗费资源了。
- 逻辑备份在某些场景下比数据库文件本身还大。
- 无法保证导出后再还原出来的一定是同样的数据。
- 从逻辑备份中还原需要MySQL加载和解释语句，转化为存储格式，并重建索引，所以这一切会很慢。（解决的方案是使用Percona Server中包含的mysqldump，可以减少2/3的还原时间）。

